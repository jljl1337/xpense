name: Publish
on:
  push:
    branches:
      - main
    tags:
      - "v*.*.*"

jobs:
  push_to_registry:
    name: Release Docker Image
    runs-on: ubuntu-latest
    permissions:
      packages: write
      contents: read
      attestations: write
      id-token: write
    steps:
      - name: Check out the repo
        uses: actions/checkout@v4
      
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_PASSWORD }}
      
      - name: Get version for tag releases
        id: get_version
        if: startsWith(github.ref, 'refs/tags/')
        uses: battila7/get-version-action@v2
      
      - name: Generate tags
        id: meta
        run: |
          IMAGE_NAME="${{ secrets.DOCKERHUB_USERNAME }}/xpense"
          
          if [[ "${{ github.ref_type }}" == "tag" ]]; then
            # Tag release - use semantic versioning tags + latest
            echo "tags<<EOF" >> $GITHUB_OUTPUT
            echo "${IMAGE_NAME}:latest" >> $GITHUB_OUTPUT
            echo "${IMAGE_NAME}:${{ steps.get_version.outputs.major }}" >> $GITHUB_OUTPUT
            echo "${IMAGE_NAME}:${{ steps.get_version.outputs.major }}.${{ steps.get_version.outputs.minor }}" >> $GITHUB_OUTPUT
            echo "${IMAGE_NAME}:${{ steps.get_version.outputs.version-without-v }}" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          else
            # Main branch commit - use commit hash + preview
            COMMIT_HASH="${{ github.sha }}"
            SHORT_COMMIT="${COMMIT_HASH:0:7}"
            echo "tags<<EOF" >> $GITHUB_OUTPUT
            echo "${IMAGE_NAME}:${COMMIT_HASH}" >> $GITHUB_OUTPUT
            echo "${IMAGE_NAME}:${SHORT_COMMIT}" >> $GITHUB_OUTPUT
            echo "${IMAGE_NAME}:preview" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          fi
      
      - name: Build and push Docker image
        id: push
        uses: docker/build-push-action@v6
        with:
          context: .
          platforms: linux/amd64,linux/arm64
          push: true
          tags: ${{ steps.meta.outputs.tags }}